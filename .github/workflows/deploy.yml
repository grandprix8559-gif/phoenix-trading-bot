name: Deploy to VPS

on:
  push:
    branches: [main]
    paths:
      - 'bot/**'
      - 'main.py'
      - 'config.py'
  workflow_dispatch:  # ìˆ˜ë™ íŠ¸ë¦¬ê±° í—ˆìš©

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            cd /root/phoenix_v5_run
            
            # ë°±ì—…
            echo "ğŸ“¦ ë°±ì—… ì¤‘..."
            mkdir -p /root/phoenix_backups
            tar -czf /root/phoenix_backups/pre_deploy_$(date +%Y%m%d_%H%M%S).tar.gz \
              --exclude='data' --exclude='logs' --exclude='venv' --exclude='__pycache__' .
            
            # Git pull
            echo "ğŸ“¥ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°..."
            git fetch origin main
            git reset --hard origin/main
            
            # ì„œë¹„ìŠ¤ ì¬ì‹œì‘
            echo "ğŸ”„ ì„œë¹„ìŠ¤ ì¬ì‹œì‘..."
            systemctl restart phoenix_v5.service
            
            # ìƒíƒœ í™•ì¸
            sleep 5
            systemctl status phoenix_v5.service --no-pager

      - name: Notify Telegram (Success)
        if: success()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "parse_mode=HTML" \
            -d "text=âœ… <b>Phoenix ë°°í¬ ì™„ë£Œ</b>%0A%0AğŸ“Œ ì»¤ë°‹: <code>${{ github.sha }}</code>%0AğŸŒ¿ ë¸Œëœì¹˜: ${{ github.ref_name }}%0AğŸ‘¤ ì‘ì„±ì: ${{ github.actor }}"

      - name: Notify Telegram (Failure)
        if: failure()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "parse_mode=HTML" \
            -d "text=âŒ <b>Phoenix ë°°í¬ ì‹¤íŒ¨</b>%0A%0AğŸ“Œ ì»¤ë°‹: <code>${{ github.sha }}</code>%0Aâš ï¸ VPS í™•ì¸ í•„ìš”!"
