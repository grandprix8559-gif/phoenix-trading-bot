name: Daily Backup

on:
  schedule:
    - cron: '0 15 * * *'  # ë§¤ì¼ ìì • KST (UTC 15:00)
  workflow_dispatch:  # ìˆ˜ë™ íŠ¸ë¦¬ê±° í—ˆìš©

jobs:
  backup:
    runs-on: ubuntu-latest
    
    steps:
      - name: Trigger VPS Backup
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd /root/phoenix_v5_run
            
            echo "ğŸ“¦ Phoenix ë°±ì—… ì‹œì‘..."
            
            # ë°±ì—… ë””ë ‰í† ë¦¬ ìƒì„±
            mkdir -p /root/phoenix_backups
            
            # ë°±ì—… ì‹¤í–‰
            BACKUP_FILE="/root/phoenix_backups/phoenix_backup_$(date +%Y%m%d_%H%M%S).tar.gz"
            tar -czf $BACKUP_FILE \
              --exclude='venv' \
              --exclude='__pycache__' \
              --exclude='*.log' \
              .
            
            echo "âœ… ë°±ì—… ì™„ë£Œ: $BACKUP_FILE"
            
            # 7ì¼ ì´ìƒ ëœ ë°±ì—… ì‚­ì œ
            echo "ğŸ—‘ï¸ ì˜¤ë˜ëœ ë°±ì—… ì •ë¦¬..."
            find /root/phoenix_backups -name "*.tar.gz" -mtime +7 -delete
            
            # ë°±ì—… ëª©ë¡ ì¶œë ¥
            echo "ğŸ“‹ ìµœê·¼ ë°±ì—… ëª©ë¡:"
            ls -lh /root/phoenix_backups/ | tail -5

      - name: Notify Telegram
        if: always()
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" = "success" ]; then
            EMOJI="âœ…"
            MSG="ë°±ì—… ì™„ë£Œ"
          else
            EMOJI="âŒ"
            MSG="ë°±ì—… ì‹¤íŒ¨"
          fi
          
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=${EMOJI} Phoenix ì¼ì¼ ${MSG}"
